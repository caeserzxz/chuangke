<layout name="common/layout_nav" />
    <div class="page friend">
        <div class="page-hd">
            <div class="header">
                <div class="header-left">
                    <a href="javascript:history.go(-1)" class="left-arrow"></a>
                </div>
                <div class="header-title">我的好友</div>
                <div class="header-right">
                    <a href="{:U('chuangke/Member/goodFriendList')}">好友列表</a>
                </div>
            </div>
        </div>
        <div class="page-bd">
            <!-- 页面内容-->

            <div class="block">
                <img src="{$data.img}" class="code_img" alt="">
                <p class="fs26 color_8" >邀请码：<span class="code">{$data.code}</span></p>
                <div class="btncCell">
                    <button class="fs28 color_w" onclick="copyUrl2()" id="Copy" data-clipboard-action="copy" data-clipboard-target="#copyUrl" >复制邀请链接</button>
                    <!--<button class="fs28 color_w" onclick="preserveImg()">保存为图片</button>-->
                    -<button class="fs28 color_w saveImg">保存为图片</button>
                </div>
            </div>
            <div class="tips fs26 color_8">
                1、每推荐一个用户注册可得50元保证金，可提现{$userInfo.wx_number}<br/>
                2、好友每次还款可获得5%-10%手续费提成<br/>
                3、好友每次众筹可获得3%-8%收益分成
            </div>
        </div>
        <!--<a href="#" download="img" id="img"></a>-->
        <div class="shareImg" >
            <img src="__PUBLIC__/static/chuangke/images/shareBG.png?v=1" alt="" class="bgimg">
            <div class="info">
                <div class="logo">
                    <if condition="$config.store_logo neq ''">
                        <img src="{$config.store_logo}" alt="" class="login_img">
                    <else/>
                        <img src="__PUBLIC__/static/chuangke/images/logo.png?v=1" alt="" >
                    </if>
                </div>
                <div class="code">
                    <img src="{$data.img}?v=1" alt="">
                    <span class="color_w">加微信：<span id="wx_number">{$user.wx_number}</span></span>
                </div>
            </div>
        </div>
    </div>
<div class="invitationBtn"  style="display: none;">我的邀请链接<div id="invitationBtn" data-clipboard-target="#Code" >一键<br>复制</div><span id="Code" class="Code">213</span></div>
<textarea  id="biao1" style="z-index: -1;" style="display: none;">{$data.url}</textarea>
<script src="https://cdn.jsdelivr.net/clipboard.js/1.5.12/clipboard.min.js"></script>
<script src="__PUBLIC__/static/chuangke/js/lib/jquery-2.1.4.js"></script>
<script src="__PUBLIC__/static/chuangke/js/jquery-weui.min.js"></script>
<script src="__PUBLIC__/static/chuangke/js/lib/fastclick.js"></script>
<script src="__PUBLIC__/static/chuangke/js/layer/layer.js"></script>
<script src="__PUBLIC__/static/chuangke/js/ios.js"></script>
<script>
    $(function() {
        FastClick.attach(document.body);
    });
</script>
<script src="https://cdn.bootcss.com/html2canvas/0.5.0-beta4/html2canvas.js"></script>
<script>
    var apptype = "{$appType}";
    console.log(apptype);
    //保存图片
    $(function () {
        //$.toast.prototype.defaults.duration=500
        $('.saveImg').on('click',function(){
            var wx_number = $('#wx_number').html();
            console.log(wx_number);
            if(wx_number==''||wx_number==null){
                layer.prompt({title: '请输入微信号', formType: 3}, function(text, index){
                    save_wx_number(text);
                });
                return false;
            }
            $.toast("断点1",'text');
            $('.page-bd').hide()
            $('.page-hd').hide()
            $('.shareImg').show()
            $.toast("断点22",'text');
            saveImg();
        })
    });
    function saveImg() {
        $.toast("断点333",'text');
        html2canvas($('.shareImg'), {
            allowTaint: true,
            scale: 2,
            ureCORS: true,
            taintTest: false,
            onrendered: function (canvas) {
                $.toast("断点4444",'text');
                var url = canvas.toDataURL();
                // $('.model').show()
                // $.toast("图片已保存",'text', function() {
                //     $('.page-bd').show()
                //     $('.page-hd').show()
                //     $('.shareImg').hide()
                // });
                $.toast("断点55555",'text');
                setTimeout(function(){
                    $('.page-bd').show();
                    $('.page-hd').show();
                    $('.shareImg').hide();
                    $.toast("断点666666",'text');
                },500)
                if(apptype=='Android'){
                    window.auc.downloadPicturetToBase64(url);
                }else if(apptype=='IOS'){
                    $.toast("调起IOS",'text');
                    callMobile('SavePhoto','',url);
                }else{
                    console.log('other');
                    //以下代码为下载此图片功能
                    var triggerDownload = $("<a>").attr("href", url).attr("download",  "saveImg.png").appendTo("body");
                    triggerDownload[0].click();
                    triggerDownload.remove();
                }

                // if (isIOS){
                //     $('.model').find('img').attr('src',url);
                //     $('.model').show()
                // }else{
                //    //以下代码为下载此图片功能
                //     var triggerDownload = $("<a>").attr("href", url).attr("download",  "saveImg.png").appendTo("body");
                //     triggerDownload[0].click();
                //     triggerDownload.remove();
                // }
            }
        });
    }

</script>
<script>
    var code = "{$data.code}";
    function copyUrl2(obj)
    {
        var Url2=document.getElementById("biao1");
        Url2.select(); // 选择对象
        document.execCommand("Copy"); // 执行浏览器复制命令
        // alert("已复制好，可贴粘。");
        layer.msg("已复制好，可贴粘。");

    }

    function preserveImg(argument) {
        // downloadPicturetToBase64(String base64DataStr)

        downloadIamge('.code_img',code);
    }
    function downloadIamge(selector, name) {
        // 通过选择器获取img元素
        var img = document.querySelector(selector)
        // 将图片的src属性作为URL地址
        var url = img.src
        var a = document.createElement('a')
        var event = new MouseEvent('click')

        a.download = name || '下载图片名称'
        a.href = url

        a.dispatchEvent(event)
    }

    function  save_wx_number(code){
        $.ajax({
            'url':"{:url('Member/save_wx_number')}",
            'type':'post',
            'data':{'code':code},
            'dataType':'json',
            'success':function(data){
                console.log(data);
                if(data.status == -1){
                    layer.msg(data.msg);
                }else if(data.status == 1){
                    window.location = "{:url('/chuangke/Member/myGoodFriend')}";
                }
            }
        });
    }
    /**
     * 在本地进行文件保存
     * @param  {String} data     要保存到本地的图片数据
     * @param  {String} filename 文件名
     */
    function saveFile(data, filename) {
        const save_link = document.createElementNS('http://www.w3.org/1999/xhtml', 'a');
        save_link.href = data;
        save_link.download = filename;

        const event = document.createEvent('MouseEvents');
        event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
        save_link.dispatchEvent(event);
    }
</script>
